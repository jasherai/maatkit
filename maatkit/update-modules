#!/bin/sh

set -e

if [ -z $1 ]; then
   echo "Specify a package to update"
   exit 1
fi

set -u
PACK=$1

if [ ! -d ../$PACK ]; then
   echo "$PACK doesn't exist"
   exit 1
fi

for FILE in `ls ../$PACK/mk-*`
do
   for MOD in `grep 'End .* package' $FILE | awk '{print $3}'`
   do
      cat $FILE | ./insert_module $MOD > $MOD.tmp
      if diff -q $FILE $MOD.tmp | grep differ > /dev/null ; then
         echo "Updating $MOD in $FILE";
         cat $MOD.tmp > $FILE;
      fi
      rm -f $MOD.tmp;
   done
done
